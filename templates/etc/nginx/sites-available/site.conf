{% if nginx_ssl_enforced %}
server {
  listen 80;
  return 301 https://$host$request_uri;
}

{% endif %}
{% if nginx_ssl_disabled %}
server {
  listen 443;
  return 301 http://$host$request_uri;
}

{% endif %}
server {
  root /data/www/docroot;
  index index.html {% if nginx_php_enabled %}index.php{% endif %};
  server_name localhost;

  location ~* {{ nginx_file_extension_blacklist }} {
    return 403;
  }

  location ~* \.(?:ico|css|js|gif|jpe?g|png|svgz?|webp|eot|ttf|woff|otf|pdf)$ {
{% if nginx_access_log_ignore_static_assets %}
    access_log off;
{% endif %}
    expires max;
    add_header Pragma public;
    add_header Cache-Control public;

{% if nginx_cors_enabled %}
{% if nginx_cors_whitelist_enabled %}
    if ($http_origin ~* ({{ nginx_cors_whitelist_protocol }}://{{ nginx_cors_whitelist_hosts }}(:[0-9]+)?)) {
        set $cors_allowed 'true';
    }
{% else %}
    set $cors_allowed 'true';
{% endif %}
    if ($cors_allowed) {
      set $cors_request $request_method;
    }

    if ($cors_request ~* ^(GET|POST)$) {
{% if nginx_cors_whitelist_enabled %}
      add_header Access-Control-Allow-Origin "$http_origin";
{% else %}
      add_header Access-Control-Allow-Origin *;
{% endif %}
      add_header Access-Control-Allow-Credentials 'true';
    }

    if ($cors_request = 'OPTIONS') {
{% if nginx_cors_whitelist_enabled %}
      add_header Access-Control-Allow-Origin "$http_origin";
{% else %}
      add_header Access-Control-Allow-Origin *;
{% endif %}
      add_header Access-Control-Allow-Credentials 'true';
      add_header Access-Control-Max-Age 1728000;
      add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
      add_header Access-Control-Allow-Headers 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since';
      add_header Content-Length 0;
      add_header Content-Type 'text/plain charset=UTF-8';

      return 204;
    }
  }
{% endif %}

{% if nginx_php_enabled %}
  location ~ \.php$ {
    fastcgi_pass unix:{{ runtime_root }}/php/fpm.sock;
    fastcgi_index index.php;
    include /etc/nginx/fastcgi_params;
  }

  location / {
    try_files $uri $uri/ /index.php?$query_string;
  }
{% else %}
  location / {
    try_files $uri $uri/ /index.html;
  }
{% endif %}
